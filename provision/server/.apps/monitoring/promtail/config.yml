server:
  http_listen_port: 9080
  grpc_listen_port: 0

clients:
  - url: http://loki:3100/loki/api/v1/push

positions:
  filename: /data/promtail/positions.yaml

scrape_configs:
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: varlogs
          host: ${HOSTNAME}
          __path__: /var/log/*.log

  - job_name: caddy
    static_configs:
      - targets:
          - localhost
        labels:
          job: caddy
          host: ${HOSTNAME}
          __path__: /data/logs/caddy/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            ts: ts
            logger: logger
            msg: msg
      - timestamp:
          source: ts
          format: Unix

  - job_name: grafana
    static_configs:
      - targets:
          - localhost
        labels:
          job: grafana
          host: ${HOSTNAME}
          __path__: /data/logs/grafana/*.log

  - job_name: journal
    journal:
      json: false
      max_age: 12h
      path: /var/log/journal
    relabel_configs:
      - source_labels: ["__journal__systemd_unit"]
        target_label: "unit"
      - source_labels: ["__journal__container_name"]
        target_label: "container"
      - source_labels: ["__journal__container_id"]
        target_label: "container_id"

  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      # Drop promtail's own logs to avoid recursion
      - source_labels: ["__meta_docker_container_name"]
        regex: "promtail"
        action: drop
      - source_labels: ["__meta_docker_container_name"]
        regex: "/(.*)"
        target_label: "container"
      - source_labels: ["__meta_docker_container_image"]
        target_label: "image"
      - source_labels: ["__meta_docker_container_label_com_docker_compose_service"]
        target_label: "compose_service"
      - source_labels: ["__meta_docker_container_label_com_docker_compose_project"]
        target_label: "compose_project"
    pipeline_stages:
      - docker: {}

  - job_name: qbittorrent
    static_configs:
      - targets:
          - localhost
        labels:
          job: qbittorrent
          container: qbittorrent
          host: ${HOSTNAME}
          __path__: /data/logs/qbittorrent/*.log
    pipeline_stages:
      - regex:
          expression: '.*\((?P<level_code>[INWC])\).*'
      - template:
          source: level
          template: |
            {{- if eq .level_code "I" -}}debug
            {{- else if eq .level_code "N" -}}info
            {{- else if eq .level_code "W" -}}warn
            {{- else if eq .level_code "C" -}}error
            {{- else -}}unknown
            {{- end -}}
      - labels:
          level:
