services:
  reverse-proxy:
    image: caddy:latest
    container_name: caddy
    restart: unless-stopped
    env_file:
      - ../global.env
    extra_hosts:
      - "docker-host:${DOCKER_GATEWAY}"
    ports:
      - "80:80"
      - "443:443"
      - "2019:2019"
    cap_add:
      - NET_BIND_SERVICE
    user: "${USER_UID}:${USER_GID}"
    volumes:
      - /srv/revproxy/caddy/data:/data
      - /srv/revproxy/caddy/config:/config
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 80 || exit 1" ]
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - proxy

networks:
  proxy:
    name: proxy
    driver: bridge
    attachable: true
    # Pin subnet/gateway so services can reliably reach host via DOCKER_GATEWAY (e.g. node-exporter)
    ipam:
      config:
        - subnet: ${DOCKER_SUBNET}
          gateway: ${DOCKER_GATEWAY}
