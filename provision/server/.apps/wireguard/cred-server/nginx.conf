server {
    listen 8080;
    server_name _;
    
    root /usr/share/nginx/html;
    
    # Root index page
    location = / {
        alias /var/www/;
        try_files /index.html =404;
    }
    
    # Hidden endpoint for root directory listing
    location = /_list {
        rewrite ^ / break;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
    }
    
    # Peer directories - serve custom index or listing
    location ~ ^/peer[0-9]+/$ {
        alias /var/www/;
        try_files /peer.html @autoindex;
    }
    
    # Hidden endpoint for peer directory listings
    location ~ ^/peer[0-9]+/_list$ {
        rewrite ^(/peer[0-9]+)/_list$ $1/ break;
        autoindex on;
    }
    
    # Autoindex fallback
    location @autoindex {
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
    }
    
    # Allow access to actual config files
    location ~ ^/peer[0-9]+/.*\.(conf|png)$ {
        try_files $uri =404;
    }
    
    # Block everything else
    location / {
        return 404;
    }
}

